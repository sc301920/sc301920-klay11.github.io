# 传输层协议
- 传输控制协议 TCP：提供面向连接的，可靠的数据传输服务
- 用户数据协议 UDP：提供无连接的，尽最大努力的数据传输服务
## Tcp
> 传输控制协议（Transmission Control Protocol，简称 TCP）是一种 面向连接（连接导向）的、可靠的、 基于 IP 协议的传输层协议。
- 面向连接：每条 TCP 连接只能有两个端点（亦即点对点，不可广播、多播），每一条 TCP 连接只能是一对一
- 可靠的传输服务：通过 TCP 连接传送的数据，无差错、不丢失、不重复、并且按序到达，丢包时通过重传机制进而增加时延实现可靠性
- 全双工通信：TCP 允许通信双方的应用进程在任何时候都能发送数据。TCP 连接的两端都设有发送缓存和接收缓存，用来临时存放双方通信的数据
- 字节流：面向字节流，TCP 中的 流（Stream）指的是流入进程或从进程流出的字节序列
- 流量缓冲：解决速度不匹配问题
### 数据包结构
TCP 首部标志比特有 6 个：URG、ACK、PSH、RST、SYN、FIN
|控制位|名称|说明|
|:-|:-:|-:|
|URG|-|紧急指针|
|ACK|-|确认序号有效|
|PSH|-|尽可能快地将数据送往接收进程|
|RST|-|可能需要重现创建建 TCP 连接|
|SYN|-|同步序号来发起一个连接|
|FIN|-|发送方完成发送任务，要求释放连接|
|Seq|-|序列号|
### 三次握手
1. 目的
- 同步连接双方的 Sequence 序列号和确认号
- 交换 TCP 窗口大小信息
2. 流程
![tcp](/tcp.png)
- 第一次握手：客户端发送 SYN，然后自己变为 SYN-SENT，seq = x
- 第二次握手：服务端收到之后，返回 SYN seq = y 和 ACK = x + 1（对于客户端发来的 SYN），自己变成 SYN-REVD
- 第三次握手：客户端再次发送 seq = x + 1, ack = y + 1给服务端，自己变成 EASTABLISHED 状态，服务端收到 ACK，也进入 ESTABLISHED
3. 次数问题
    - 为什么不是两次
    无法确认客户端的接收能力。
    - 为什么不是四次？
    四次以上都可以，只不过 三次就够了
### 四次挥手
1. 流程
- 第一次挥手：客户端设置 seq =x，发送一个 FIN 报文段，用于关闭客户端到服务器端的数据传送，客户端进入 FIN_WAIT_1 状态。意思是说「我客户端没有数据要发给你了」，但是如果你服务器端还有数据没有发送完成，则不必急着关闭连接，可以继续发送数据。
- 第二次挥手：服务器端收到 FIN 报文段，回复 ACK 报文段，ACK = X + 1，告诉客户端，你的请求我收到了，我同意你的关闭请求。这个时候客户端就进入 FIN_WAIT_2 状态。
- 第三次挥手：当服务器端确定数据已发送完成，则向客户端发送 FIN 报文段，告诉客户端，好了，我这边数据发完了，准备好关闭连接了。服务器端进入 LAST_ACK 状态。
- 第四次挥手：客户端收到 FIN 报文段后，就知道可以关闭连接了，但是他还是不相信网络，怕服务器端不知道要关闭，所以发送 ACK 报文段回复服务端，然后进入 TIME_WAIT 状态，如果服务端端没有收到 ACK 则可以重传。服务器端收到 ACK 后，就知道可以断开连接了。客户端等待了 2MSL（通常是两分钟）后依然没有收到回复，则证明服务器端已正常关闭，那好，我客户端也可以关闭连接了。最终完成了四次握手。
> MSL（Maximum Segment Lifetime）报文最大生存时间。维持 2MSL 时长的 TIME-WAIT 状态，保证至少一次报文的往返时间内端口是不可复用。
2. 次数问题
由于 TCP 连接采取全双工的通信方式，因此每个方向都必须单独进行关闭
### 有效传输
- TCP 会确认发送了哪些报文，接收方受到了哪些报文，哪些没有收到，保证数据包按序到达，不允许有差错
- 如果出现丢包或者网络状况不佳，则会跳转自己的行为，减少发送的速度或者重发
###  拥塞控制
原因是有可能整个网络环境特别差，容易丢包，那么发送端就应该注意了
主要用三种方法：
- 慢启动阈值 + 拥塞避免
- 快速重传
- 快速回复
## UDP
用户数据报协议（User Datagram Protocol，UDP），又称使用者资料包协定，是一个简单的面向数据包的传输层协议
- 无需建立连接（减少延迟）
- 尽最大努力交付，即不保证可靠交付，因此主机不需要维持复杂的链接状态
- UDP 的首部开销小，只有 8 个字节，比 TCP 的 20 个字节的首部要短
- 没有拥塞控制，因此网络出现拥塞不会使源主机的发送速率降低
- 支持一对一、一对多、多对一和多对多的交互通信
